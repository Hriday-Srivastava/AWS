name: Kubernetes CI

on:
  push:
    branches: [ "main" ]

jobs:
  sbcrudk8s-ci:
    runs-on: ubuntu-latest

    steps:
    - name: Code Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Maven Build
      run: mvn clean package -DskipTests
      working-directory: k8scruddemo

    - name: Build Docker Image
      run: docker build -t hridaysrivastava/k8scruddemoapp:${GITHUB_SHA::7} .
      working-directory: k8scruddemo

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push Image to DockerHub
      run: docker push hridaysrivastava/k8scruddemoapp:${GITHUB_SHA::7}

    # -------- Install yq ----------
    - name: Install yq
      run: |
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq

    # -------- Update Deployment YAML ----------
    - name: Update image tag in Deployment file
      run: |
        yq -i '.spec.template.spec.containers[0].image = "hridaysrivastava/k8scruddemoapp:${GITHUB_SHA::7}"' k8scruddemo/k8s-cruddemoapp-deploy-svc.yml

    # -------- Commit updated file back to repo ----------
    - name: Commit and Push changes
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "github-actions"

        git add k8s-cruddemoapp-deploy-svc.yml
        git commit -m "Update image tag to ${GITHUB_SHA::7}"
        git push
